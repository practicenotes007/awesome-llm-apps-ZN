# 🗄️ 教程5.2：持久化对话代理

欢迎来到持久化会话管理！本教程教您如何使用带有SQLite的`DatabaseSessionService`创建一个能够跨多个会话记住对话的AI代理。

## 🎯 您将学到什么

- **DatabaseSessionService**：使用SQLite的持久化会话存储
- **跨会话记忆**：在程序重启后记住对话
- **数据库管理**：设置和管理会话数据库
- **数据持久化**：长期存储对话历史
- **会话恢复**：检索以前的对话

## 🧠 核心概念：持久化会话

**DatabaseSessionService**将数据存储在SQLite数据库文件中。这意味着：
- ✅ **持久化存储** - 数据在程序重启后仍然存在
- ✅ **跨会话记忆** - 跨会话记住对话
- ✅ **数据完整性** - SQLite的ACID合规性
- ✅ **可扩展** - 可以处理多个用户和会话
- ❌ **需要设置** - 需要初始化数据库
- ❌ **基于文件** - 仅限于单台机器

适用于：
- 生产应用程序
- 多用户系统
- 长期对话历史
- 数据分析和洞察

## 🔧 关键组件

### 1. **DatabaseSessionService**
```python
from google.adk.sessions import DatabaseSessionService
```

### 2. **数据库结构**
```
┌─────────────────────────────────────────────────────────────┐
│                    SQLITE DATABASE                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   SESSIONS  │  │    STATE    │  │   EVENTS    │         │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤         │
│  │ session_id  │  │ session_id  │  │ event_id    │         │
│  │ user_id     │  │ state_data  │  │ session_id  │         │
│  │ app_name    │  │ updated_at  │  │ event_type  │         │
│  │ created_at  │  └─────────────┘  │ content     │         │
│  └─────────────┘                   │ timestamp   │         │
│                                    └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### 3. **带持久化的会话生命周期**
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   创建      │───▶│   使用      │───▶│   关闭      │
│  会话       │    │  会话       │    │  会话       │
│  (数据库)   │    │  (数据库)   │    │  (数据库)   │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  数据库     │    │  数据库     │    │  数据库     │
│  创建       │    │  更新       │    │  归档       │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 🚀 教程概述

在本教程中，我们将创建一个**简单持久化代理**，它可以：
- 在程序重启后记住对话
- 使用SQLite数据库进行持久化存储
- 演示基本的跨会话记忆
- 展示与内存中会话的区别

## 📁 项目结构

```
5_2_persistent_conversation/
├── README.md              # 本文件 - 概念解释
├── requirements.txt       # 依赖项
├── agent.py              # 带数据库会话管理的主代理
├── app.py                # Streamlit Web界面
└── sessions.db           # SQLite数据库（自动创建）
```

## 🎯 学习目标

完成本教程后，您将理解：
- ✅ 如何使用SQLite设置DatabaseSessionService
- ✅ 如何创建持久化会话
- ✅ 如何跨会话检索对话历史
- ✅ 如何管理数据库连接和事务
- ✅ 如何构建长期记忆的代理

## 🚀 开始使用

1. **安装依赖项**：
   ```bash
   pip install -r requirements.txt
   ```

2. **设置环境**：
   ```bash
   # 使用您的Google AI API密钥创建.env文件
   echo "GOOGLE_API_KEY=your_api_key_here" > .env
   ```

3. **运行代理**：
   ```bash
   # 启动Streamlit应用
   streamlit run app.py
   ```

4. **测试持久化**：
   - 与代理进行对话
   - 关闭浏览器/应用
   - 重启应用
   - 继续对话 - 它会记住！

## 🔍 代码演练

### 关键数据库会话管理代码：

```python
# 1. 创建数据库会话服务
session_service = DatabaseSessionService(
    db_url="sqlite:///sessions.db"
)

# 2. 初始化数据库（创建表）
await session_service.initialize()

# 3. 创建或检索会话
session = await session_service.get_session(
    app_name="demo",
    user_id="user123",
    session_id="session_user123"
)

# 4. 与Runner一起用于代理执行
async for event in runner.run_async(
    user_id=user_id,
    session_id=session_id,
    new_message=user_content
):
    # 处理响应
```

## 🎯 测试您的代理

尝试这些持久化测试：

### 测试1：跨会话记忆
```
会话1:
用户: "我的名字是鲍勃"
代理: "很高兴认识你，鲍勃！"

会话2 (重启后):
用户: "我的名字是什么？"
代理: "你的名字是鲍勃！"
```

### 测试2：兴趣记忆
```
会话1:
用户: "我喜欢编程"
代理: "太好了！编程是一项很棒的技能。"

会话2 (重启后):
用户: "我喜欢什么？"
代理: "你喜欢编程！"
```

### 测试3：数据库验证
```
1. 进行对话
2. 检查项目目录中的sessions.db文件
3. 重启应用
4. 继续对话 - 它会记住！
```

## 🔗 下一步

完成本教程后，您可以继续：
- **[教程5.3：云记忆](../5_3_cloud_memory/README.md)** - 学习基于云的会话存储
- **高级数据库模式** - 多用户会话管理
- **数据分析** - 分析对话模式

## 💡 专业提示

- **数据库位置**：SQLite文件在您的项目目录中创建
- **备份策略**：考虑备份sessions.db文件
- **性能**：SQLite对中小型应用程序来说很快
- **扩展**：对于大型应用程序，考虑使用PostgreSQL或云数据库

## 🚨 重要说明

- **数据库文件**：在您的项目目录中将创建一个`sessions.db`文件
- **数据持久化**：对话在程序重启后仍然存在
- **文件权限**：确保项目目录中有写入权限
- **备份**：数据库文件包含所有对话数据 - 请备份！