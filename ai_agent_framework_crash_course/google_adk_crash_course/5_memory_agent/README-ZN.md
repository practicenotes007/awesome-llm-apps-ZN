# 🧠 教程5：记忆代理 - 会话、状态和事件

欢迎来到记忆和会话管理教程！本教程教您如何创建能够记住对话、保持上下文并在多次交互中提供个性化体验的AI代理。

## 🎯 您将学到什么

- **会话管理**：代理如何维护对话上下文
- **状态持久化**：存储和检索对话数据
- **事件跟踪**：理解对话流程和历史
- **记忆类型**：内存、数据库和基于云的记忆解决方案
- **个性化**：创建能记住用户偏好的代理

## 🧠 核心概念

### 1. **会话** - 对话容器

**会话**就像一个对话线程，用于跟踪用户和代理之间的所有交互。

```
┌─────────────────────────────────────────────────────────────┐
│                    会话生命周期                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   创建      │───▶│   活动      │───▶│   关闭      │     │
│  │  会话       │    │  对话       │    │   会话      │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         │                   │                   │           │
│         ▼                   ▼                   ▼           │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │  用户ID     │    │   事件      │    │   记忆      │     │
│  │  创建时间   │    │   状态      │    │   存储      │     │
│  │  时间戳     │    │   历史      │    │   归档      │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

**示例**：当您开始与旅行代理聊天时，会创建一个会话。您关于航班、酒店和偏好的所有问题都存储在该会话中。

### 2. **状态** - 当前上下文

**状态**表示代理在对话期间需要记住的当前上下文和数据。

```
┌─────────────────────────────────────────────────────────────┐
│                        会话状态                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   用户状态      │  │  代理状态       │  │  应用状态   │ │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────┤ │
│  │ • 用户ID        │  │ • 代理名称      │  │ • 会话ID    │ │
│  │ • 偏好          │  │ • 当前任务      │  │ • 时间戳    │ │
│  │ • 历史          │  │ • 使用的工具    │  │ • 状态      │ │
│  │ • 上下文        │  │ • 记忆          │  │ • 元数据    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**示例**：旅行代理的状态可能包括：
- 用户偏好的目的地
- 预算限制
- 旅行日期
- 之前的推荐

### 3. **事件** - 对话历史

**事件**是构成对话历史的单个交互。

```
┌─────────────────────────────────────────────────────────────┐
│                      事件流                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   用户      │───▶│   代理      │───▶│   响应      │     │
│  │  消息       │    │  处理       │    │  生成       │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         │                   │                   │           │
│         ▼                   ▼                   ▼           │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │ 事件类型：  │    │ 事件类型：  │    │ 事件类型：  │     │
│  │ user_input  │    │ processing  │    │ response    │     │
│  │ 时间戳      │    │ 时间戳      │    │ 时间戳      │     │
│  │ 内容        │    │ 持续时间    │    │ 内容        │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

**示例事件序列**：
1. **用户事件**："我想去巴黎"
2. **代理事件**：处理请求，检查偏好
3. **响应事件**："太好了！我看到您喜欢豪华酒店。这里有一些选择..."

### 4. **会话运行时流程**

```
┌─────────────────────────────────────────────────────────────┐
│                    会话运行时流程                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 会话创建                                                │
│  ┌─────────────┐                                            │
│  │ 用户开始    │───▶ 使用用户ID创建会话                      │
│  │ 对话        │    初始化状态和记忆                         │
│  └─────────────┘                                            │
│                                                             │
│  2. 对话循环                                                │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   用户      │───▶│   代理      │───▶│   更新      │     │
│  │  输入       │    │  处理       │    │   状态      │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         │                   │                   │           │
│         ▼                   ▼                   ▼           │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │ 记录        │    │ 使用上下文  │    │ 存储        │     │
│  │ 事件        │    │ 和记忆      │    │ 响应        │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│                                                             │
│  3. 会话关闭                                                │
│  ┌─────────────┐                                            │
│  │ 用户结束    │───▶ 保存最终状态                            │
│  │ 对话        │    归档会话                                 │
│  └─────────────┘    存储到记忆库中                          │
└─────────────────────────────────────────────────────────────┘
```

## 📚 教程结构

本教程分为三个递进级别：

1. **[5_1_in_memory_conversation](./5_1_in_memory_conversation/README.md)** - 基本会话管理
   - 用于临时对话的InMemorySessionService
   - 简单状态管理
   - 事件跟踪基础

2. **[5_2_persistent_conversation](./5_2_persistent_conversation/README.md)** - 数据库持久化
   - 带有SQLite的DatabaseSessionService
   - 持久化状态存储
   - 跨会话的对话历史

## 🛠️ 先决条件

在开始本教程之前，请确保您已具备：

- **Python 3.11+** 已安装
- 来自[Google AI Studio](https://aistudio.google.com/)的**Google AI API密钥**
- **SQLite**（通常随Python一起提供）
- 数据库基础知识（用于教程5_2）

## 📖 如何使用本课程

每个教程都遵循一致的结构：

- **README.md**：概念解释和学习目标
- **agent.py**：包含代理实现
- **requirements.txt**：教程的依赖项
- **app.py**：Streamlit Web界面（如适用）

### 学习方法：
1. **阅读README**以理解记忆概念
2. **检查代码**以查看会话管理实现
3. **运行示例**以查看记忆的实际效果
4. **实验**进行多轮对话
5. **准备好时进入下一个教程**

## 🎯 教程特点

每个教程包括：
- ✅ **清晰的概念解释**
- ✅ **最小的可工作代码示例**
- ✅ **实际用例**
- ✅ **逐步说明**
- ✅ **记忆持久化演示**

## 🔗 下一步

完成本教程后，您可以继续：
- **高级代理模式** - 多代理系统
- **自定义记忆实现** - 构建您自己的记忆服务
- **生产部署** - 扩展记忆代理

## 💡 专业提示

- **从简单开始**：在转向持久化之前先从内存会话开始
- **测试对话**：进行多轮对话以查看记忆的实际效果
- **监控状态**：使用ADK Web界面检查会话状态
- **规划记忆策略**：为您的用例选择合适的记忆服务